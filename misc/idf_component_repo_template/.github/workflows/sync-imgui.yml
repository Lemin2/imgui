name: sync-upstream-imgui

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Upstream tag to sync (defaults to latest release)"
        required: false
      include_demo:
        description: "Include imgui_demo.cpp"
        required: false
        default: "true"
  schedule:
    - cron: "0 3 * * *"  # daily at 03:00 UTC

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_REPO: ocornut/imgui
      COMPONENT_NAME: imgui
      INCLUDE_DEMO: ${{ github.event.inputs.include_demo || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine upstream tag
        id: tag
        shell: bash
        run: |
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=$(curl -sSL https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest | jq -r .tag_name)
          fi
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            echo "Failed to resolve upstream tag" >&2; exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

      - name: Download upstream tarball
        shell: bash
        run: |
          set -euxo pipefail
          TAG='${{ steps.tag.outputs.tag }}'
          curl -sSL -H 'Accept: application/vnd.github+json' \
            -o imgui.tar.gz \
            "https://api.github.com/repos/${UPSTREAM_REPO}/tarball/${TAG}"
          mkdir -p work out
          tar -xzf imgui.tar.gz -C work
          SRCDIR=$(echo work/*)
          echo "SRCDIR=$SRCDIR"

      - name: Stage core files
        shell: bash
        run: |
          set -euxo pipefail
          SRCDIR=$(echo work/*)
          # Copy core headers/sources
          cp "$SRCDIR"/imconfig.h out/
          cp "$SRCDIR"/imgui.h out/
          cp "$SRCDIR"/imgui_internal.h out/
          cp "$SRCDIR"/imgui.cpp out/
          cp "$SRCDIR"/imgui_draw.cpp out/
          cp "$SRCDIR"/imgui_tables.cpp out/
          cp "$SRCDIR"/imgui_widgets.cpp out/
          # Optional demo
          if [[ "${INCLUDE_DEMO}" == "true" ]]; then
            cp "$SRCDIR"/imgui_demo.cpp out/ || true
          fi
          # Include misc directory (tools, fonts helpers, etc.)
          if [[ -d "$SRCDIR/misc" ]]; then
            mkdir -p out/misc
            cp -a "$SRCDIR/misc"/* out/misc/
          fi
          # stb deps
          cp "$SRCDIR"/imstb_""*.h out/
          # license
          cp "$SRCDIR"/LICENSE.txt out/

      - name: Generate CMakeLists.txt
        shell: bash
        run: |
          cat > out/CMakeLists.txt << 'EOF'
          # Auto-generated by sync-upstream-imgui workflow
          idf_component_register(
              SRCS
                  imgui.cpp
                  imgui_draw.cpp
                  imgui_tables.cpp
                  imgui_widgets.cpp
              INCLUDE_DIRS
                  .
          )
          # Optionally include demo if present
          if(EXISTS "${CMAKE_CURRENT_LIST_DIR}/imgui_demo.cpp")
              target_sources(${COMPONENT_LIB} PRIVATE imgui_demo.cpp)
          endif()
          target_compile_definitions(${COMPONENT_LIB} PUBLIC IMGUI_DISABLE_OBSOLETE_FUNCTIONS=1)
          EOF

      - name: Generate idf_component.yml
        shell: bash
        run: |
          TAG='${{ steps.tag.outputs.tag }}'
          cat > out/idf_component.yml << EOF
          name: ${COMPONENT_NAME}
          version: "${TAG}"
          description: "Dear ImGui core as ESP-IDF component (auto-synced from upstream releases)"
          license: MIT
          url: https://github.com/${{ github.repository }}
          repository: https://github.com/${{ github.repository }}.git
          issues: https://github.com/${{ github.repository }}/issues
          keywords: [ui, gui, imgui]
          maintainers:
            - name: ${COMPONENT_NAME} Mirror Bot
              email: noreply@users.noreply.github.com
          EOF

      - name: Generate README.md
        shell: bash
        run: |
          TAG='${{ steps.tag.outputs.tag }}'
          cat > out/README.md << EOF
          # ${COMPONENT_NAME} (ESP-IDF Component)

          Auto-synced mirror of [ocornut/imgui](https://github.com/ocornut/imgui) core files as an ESP-IDF component.

          - Upstream tag: ${TAG}
          - This repo contains core sources plus \`misc/\` helpers (no platform backends/examples from upstream other than the demo file if enabled).
          - License is MIT (see LICENSE.txt from upstream).

          ## Usage

          In your project's `CMakeLists.txt`:

          ```cmake
          idf_component.yml
          
          idf_component_register(
            SRCS main.c
            REQUIRES ${COMPONENT_NAME}
          )
          ```

          In code:

          ```c
          #include "imgui.h"
          ```

          The \`misc/\` directory is included for convenience (e.g. fonts, debug tools). If you don't need it in your app artifact you can exclude it via your build packaging rules.

          ### Demo
          By default this mirror includes \`imgui_demo.cpp\`. When manually dispatching the sync workflow you can set `include_demo=false` to exclude it.

          ## Notes
          - Platform backends or software renderer should be provided as a separate component/library.
          EOF

      - name: Replace repo content (keep .git and .github)
        shell: bash
        run: |
          set -euxo pipefail
          shopt -s dotglob
          # Ensure out/ exists before we start deleting
          if [[ ! -d out ]]; then
            echo "ERROR: out/ directory not found before replace step" >&2
            ls -la || true
            exit 1
          fi
          mkdir -p keep
          # Preserve .github
          if [[ -d .github ]]; then cp -a .github keep/; fi
          # Move out/ under keep/ so it won't be deleted by cleanup loop
          mv out keep/out
          # Remove everything except .git and keep/
          for f in * .*; do
            [[ "$f" == "." || "$f" == ".." || "$f" == ".git" || "$f" == "keep" ]] && continue
            rm -rf "$f"
          done
          # Restore .github and copy staged files from keep/out
          if [[ -d keep/.github ]]; then mv keep/.github .github; fi
          cp -a keep/out/* ./
          rm -rf keep

      - name: Commit and tag
        shell: bash
        run: |
          set -euxo pipefail
          TAG='${{ steps.tag.outputs.tag }}'
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"; exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Sync upstream ${TAG}"
          # Create/update tag for component
          CTAG="idf-${TAG}"
          git tag -f "$CTAG"
          git push origin HEAD:refs/heads/main || git push origin HEAD:refs/heads/master || true
          git push --force origin "$CTAG"
